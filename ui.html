<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      width: 100%;
      height: 100%;
      margin: 0;
    }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 12px;
      color: var(--figma-color-text, #333);
      background: var(--figma-color-bg, #fff);
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--figma-color-border, #e5e5e5);
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }

    .badge {
      font-size: 11px;
      font-weight: 600;
      background: var(--figma-color-bg-secondary, #f0f0f0);
      color: var(--figma-color-text-secondary, #666);
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* â”€â”€ Table Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrap {
      flex: 1;
      width: 100%;
      overflow: auto;
      min-height: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    /* â”€â”€ Table Head â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    thead {
      position: sticky;
      top: 0;
      z-index: 2;
    }

    thead th {
      background: var(--figma-color-bg-secondary, #f5f5f5);
      font-size: 11px;
      font-weight: 600;
      text-align: left;
      padding: 8px 10px;
      color: var(--figma-color-text-secondary, #888);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-bottom: 1px solid var(--figma-color-border, #e0e0e0);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      user-select: none;
      transition: background 0.12s ease;
    }

    thead th:hover {
      background: var(--figma-color-bg-hover, #eaeaea);
    }

    thead th .sort-arrow {
      font-size: 10px;
      margin-left: 4px;
      opacity: 0.4;
    }

    thead th.sorted .sort-arrow {
      opacity: 1;
    }

    th:nth-child(1) {
      width: 26%;
    }

    th:nth-child(2) {
      width: 20%;
    }

    th:nth-child(3) {
      width: 10%;
    }

    th:nth-child(4) {
      width: 18%;
    }

    th:nth-child(5) {
      width: 13%;
    }

    th:nth-child(6) {
      width: 13%;
    }

    /* â”€â”€ Table Body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    tbody tr {
      border-bottom: 1px solid var(--figma-color-border, #f0f0f0);
      cursor: pointer;
      transition: background 0.1s ease;
      user-select: none;
    }

    tbody tr:hover {
      background: var(--figma-color-bg-hover, rgba(0, 100, 255, 0.06));
    }

    tbody tr:nth-child(even) {
      background: var(--figma-color-bg-secondary, rgba(0, 0, 0, 0.015));
    }

    tbody tr:nth-child(even):hover {
      background: var(--figma-color-bg-hover, rgba(0, 100, 255, 0.06));
    }

    /* Selected row */
    tbody tr.selected {
      background: rgba(0, 100, 255, 0.12) !important;
    }

    tbody td {
      padding: 7px 10px;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
    }

    td.text-content {
      font-weight: 500;
    }

    td.style-name {
      font-weight: 500;
    }

    td.font-info {
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 11px;
    }

    td.numeric {
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 11px;
      text-align: left;
    }

    /* â”€â”€ Unlinked row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    tr.unlinked td {
      color: #e00;
    }

    /* â”€â”€ Mixed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mixed {
      color: #d4a017;
      font-style: italic;
    }

    /* â”€â”€ Modified row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    tr.modified td {
      color: #00C853;
      background: #E8F5E9;
    }

    .footer-info .modified-count {
      color: #00C853;
      font-weight: 600;
    }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-top: 1px solid var(--figma-color-border, #e5e5e5);
      flex-shrink: 0;
    }

    .footer-info {
      font-size: 11px;
      color: var(--figma-color-text-secondary, #999);
    }

    .footer-info .unlinked-count {
      color: #e00;
      font-weight: 600;
    }

    .footer-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: var(--figma-color-bg-brand, #0d99ff);
      color: #fff;
    }

    .btn-primary:hover {
      background: #0b85e0;
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .btn-secondary {
      background: var(--figma-color-bg-secondary, #f0f0f0);
      color: var(--figma-color-text, #333);
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    /* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 8px;
      color: var(--figma-color-text-secondary, #999);
    }

    .empty-state .icon {
      font-size: 32px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 13px;
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>ğŸ“ Text Finder</h1>
    <span class="badge" id="count">0 items</span>
  </div>

  <div class="table-wrap" id="tableWrap">
    <div class="empty-state" id="emptyState">
      <span class="icon">ğŸ”</span>
      <p>ë¶„ì„ ì¤‘...</p>
    </div>
    <table id="resultTable" style="display:none">
      <thead>
        <tr>
          <th data-key="textContent">í…ìŠ¤íŠ¸ ë‚´ìš© <span class="sort-arrow"></span></th>
          <th data-key="styleName">ìŠ¤íƒ€ì¼ ì´ë¦„ <span class="sort-arrow"></span></th>
          <th data-key="fontSize">í¬ê¸° <span class="sort-arrow"></span></th>
          <th data-key="fontFamily">í°íŠ¸ <span class="sort-arrow"></span></th>
          <th data-key="letterSpacing">ìê°„ <span class="sort-arrow"></span></th>
          <th data-key="lineHeight">í–‰ê°„ <span class="sort-arrow"></span></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer">
    <div class="footer-info" id="footerInfo"></div>
    <div class="footer-actions">
      <button class="btn btn-secondary" id="btnClose">ë‹«ê¸°</button>
      <button class="btn btn-primary" id="btnCopy" disabled>ğŸ“‹ CSV ë³µì‚¬</button>
    </div>
  </div>

  <script>
    var rawData = [];       // original unsorted data from plugin
    var tableData = [];     // currently displayed (possibly sorted)
    var selectedIndices = new Set();
    var lastClickedIndex = -1;
    var sortKey = null;
    var sortOrder = 'asc';  // 'asc' or 'desc'

    function escapeCell(val) {
      if (val == null) return '';
      var str = String(val);
      if (/[\t\n\r"]/.test(str)) return '"' + str.replace(/"/g, '""') + '"';
      return str;
    }

    function esc(val) {
      return String(val).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function cellHtml(val, cls) {
      var s = String(val);
      var isMixed = s === 'Mixed' || s.indexOf('ğŸŸ¡') !== -1;
      var classes = cls || '';
      if (isMixed) classes += ' mixed';
      return '<td class="' + classes.trim() + '" title="' + esc(s) + '">' + esc(s) + '</td>';
    }

    // â”€â”€ Update row selection visuals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateSelectionVisuals() {
      var rows = document.querySelectorAll('#tbody tr');
      rows.forEach(function (row, i) {
        if (selectedIndices.has(i)) {
          row.classList.add('selected');
        } else {
          row.classList.remove('selected');
        }
      });
    }

    // â”€â”€ Send selected node IDs to plugin â”€â”€â”€â”€â”€
    function notifySelection() {
      var ids = [];
      selectedIndices.forEach(function (i) {
        if (tableData[i] && tableData[i].nodeId) {
          ids.push(tableData[i].nodeId);
        }
      });
      if (ids.length === 1) {
        parent.postMessage({ pluginMessage: { type: 'select-node', nodeId: ids[0] } }, '*');
      } else if (ids.length > 1) {
        parent.postMessage({ pluginMessage: { type: 'select-nodes', ids: ids } }, '*');
      }
    }

    // â”€â”€ Handle row click with modifiers â”€â”€â”€â”€â”€â”€
    function handleRowClick(index, e) {
      if (e.metaKey || e.ctrlKey) {
        // Cmd/Ctrl + Click: toggle individual
        if (selectedIndices.has(index)) {
          selectedIndices.delete(index);
        } else {
          selectedIndices.add(index);
        }
      } else if (e.shiftKey && lastClickedIndex !== -1) {
        // Shift + Click: range select
        var start = Math.min(lastClickedIndex, index);
        var end = Math.max(lastClickedIndex, index);
        for (var i = start; i <= end; i++) {
          selectedIndices.add(i);
        }
      } else {
        // Normal click: single select
        selectedIndices.clear();
        selectedIndices.add(index);
      }
      lastClickedIndex = index;
      updateSelectionVisuals();
      notifySelection();
    }

    // â”€â”€ Sort data (3-state: asc â†’ desc â†’ default) â”€â”€
    function sortData(key) {
      if (sortKey === key) {
        if (sortOrder === 'asc') {
          sortOrder = 'desc';
        } else if (sortOrder === 'desc') {
          // Reset to default
          sortKey = null;
          sortOrder = 'default';
          tableData = rawData.slice();
          // Clear all header arrows
          document.querySelectorAll('thead th').forEach(function (th) {
            th.classList.remove('sorted');
            var arrow = th.querySelector('.sort-arrow');
            if (arrow) arrow.textContent = '';
          });
          selectedIndices.clear();
          lastClickedIndex = -1;
          renderRows();
          return;
        }
      } else {
        sortKey = key;
        sortOrder = 'asc';
      }

      tableData = rawData.slice().sort(function (a, b) {
        var va = String(a[key] || '').toLowerCase();
        var vb = String(b[key] || '').toLowerCase();
        var na = parseFloat(va), nb = parseFloat(vb);
        if (!isNaN(na) && !isNaN(nb)) {
          return sortOrder === 'asc' ? na - nb : nb - na;
        }
        if (va < vb) return sortOrder === 'asc' ? -1 : 1;
        if (va > vb) return sortOrder === 'asc' ? 1 : -1;
        return 0;
      });

      // Update header arrows
      document.querySelectorAll('thead th').forEach(function (th) {
        var k = th.getAttribute('data-key');
        var arrow = th.querySelector('.sort-arrow');
        if (k === key) {
          th.classList.add('sorted');
          arrow.textContent = sortOrder === 'asc' ? 'â–²' : 'â–¼';
        } else {
          th.classList.remove('sorted');
          arrow.textContent = '';
        }
      });

      selectedIndices.clear();
      lastClickedIndex = -1;
      renderRows();
    }

    // â”€â”€ Render table body only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRows() {
      var tbody = document.getElementById('tbody');
      tbody.innerHTML = tableData.map(function (r, i) {
        var classes = [];
        if (r.isUnlinked) classes.push('unlinked');
        if (r.isModified) classes.push('modified');
        return '<tr class="' + classes.join(' ') + '" data-index="' + i + '" data-id="' + esc(r.nodeId) + '">'
          + cellHtml(r.textContent, 'text-content')
          + cellHtml(r.styleName, 'style-name')
          + cellHtml(r.fontSize, 'numeric')
          + cellHtml(r.fontFamily, 'font-info')
          + cellHtml(r.letterSpacing, 'numeric')
          + cellHtml(r.lineHeight, 'numeric')
          + '</tr>';
      }).join('');
    }

    // â”€â”€ Render table (full) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTable(rows) {
      rawData = rows;
      // Apply current sort if active
      if (sortKey && sortOrder !== 'default') {
        tableData = rawData.slice().sort(function (a, b) {
          var va = String(a[sortKey] || '').toLowerCase();
          var vb = String(b[sortKey] || '').toLowerCase();
          var na = parseFloat(va), nb = parseFloat(vb);
          if (!isNaN(na) && !isNaN(nb)) {
            return sortOrder === 'asc' ? na - nb : nb - na;
          }
          if (va < vb) return sortOrder === 'asc' ? -1 : 1;
          if (va > vb) return sortOrder === 'asc' ? 1 : -1;
          return 0;
        });
      } else {
        tableData = rows;
      }

      selectedIndices.clear();
      lastClickedIndex = -1;

      var tbody = document.getElementById('tbody');
      var table = document.getElementById('resultTable');
      var empty = document.getElementById('emptyState');
      var count = document.getElementById('count');
      var btnCopy = document.getElementById('btnCopy');
      var footerInfo = document.getElementById('footerInfo');

      if (!rows || rows.length === 0) {
        table.style.display = 'none';
        empty.querySelector('p').textContent = 'í…ìŠ¤íŠ¸ ë ˆì´ì–´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤';
        empty.style.display = 'flex';
        count.textContent = '0 items';
        btnCopy.disabled = true;
        footerInfo.textContent = '';
        return;
      }

      empty.style.display = 'none';
      table.style.display = 'table';
      count.textContent = rows.length + ' item' + (rows.length > 1 ? 's' : '');
      btnCopy.disabled = false;

      var unlinkedCount = rows.filter(function (r) { return r.isUnlinked; }).length;
      var modifiedCount = rows.filter(function (r) { return r.isModified; }).length;
      var infoParts = [];
      if (unlinkedCount > 0) {
        infoParts.push('âš ï¸ ë¯¸ì—°ê²°: <span class="unlinked-count">' + unlinkedCount + 'ê°œ</span>');
      }
      if (modifiedCount > 0) {
        infoParts.push('ğŸŸ¢ ìˆ˜ì •ë¨: <span class="modified-count">' + modifiedCount + 'ê°œ</span>');
      }
      if (infoParts.length === 0) {
        footerInfo.innerHTML = 'âœ… ëª¨ë“  í…ìŠ¤íŠ¸ì— ìŠ¤íƒ€ì¼ ì—°ê²°ë¨';
      } else {
        footerInfo.innerHTML = infoParts.join(' &nbsp;â”‚&nbsp; ');
      }

      renderRows();
    }

    // â”€â”€ Event delegation: tbody clicks â”€â”€â”€â”€â”€
    document.getElementById('tbody').addEventListener('click', function (e) {
      var tr = e.target.closest('tr');
      if (!tr) return;
      var idx = parseInt(tr.getAttribute('data-index'), 10);
      if (!isNaN(idx)) handleRowClick(idx, e);
    });

    // â”€â”€ Event delegation: thead clicks (sorting) â”€â”€
    document.querySelector('thead tr').addEventListener('click', function (e) {
      var th = e.target.closest('th');
      if (!th) return;
      var key = th.getAttribute('data-key');
      if (key) sortData(key);
    });

    // â”€â”€ Copy as TSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btnCopy').addEventListener('click', function () {
      if (tableData.length === 0) return;
      var header = ['í…ìŠ¤íŠ¸ ë‚´ìš©', 'ìŠ¤íƒ€ì¼ ì´ë¦„', 'í¬ê¸°', 'í°íŠ¸', 'ìê°„', 'í–‰ê°„'];
      var lines = [header.join('\t')];
      tableData.forEach(function (r) {
        lines.push([
          escapeCell(r.textContent), escapeCell(r.styleName),
          escapeCell(r.fontSize), escapeCell(r.fontFamily),
          escapeCell(r.letterSpacing), escapeCell(r.lineHeight)
        ].join('\t'));
      });
      var tsv = lines.join('\n');
      var ta = document.createElement('textarea');
      ta.value = tsv; ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);

      var btn = document.getElementById('btnCopy');
      var orig = btn.textContent;
      btn.textContent = 'âœ… ë³µì‚¬ë¨!'; btn.style.background = '#22c55e';
      setTimeout(function () { btn.textContent = orig; btn.style.background = ''; }, 1500);
    });

    document.getElementById('btnClose').addEventListener('click', function () {
      parent.postMessage({ pluginMessage: { type: 'close' } }, '*');
    });

    // â”€â”€ Show empty state with message â”€â”€â”€â”€â”€â”€
    function showEmptyState(msg) {
      var table = document.getElementById('resultTable');
      var empty = document.getElementById('emptyState');
      var count = document.getElementById('count');
      var btnCopy = document.getElementById('btnCopy');
      var footerInfo = document.getElementById('footerInfo');
      table.style.display = 'none';
      empty.querySelector('.icon').textContent = 'ğŸ”';
      empty.querySelector('p').textContent = msg;
      empty.style.display = 'flex';
      count.textContent = '0 items';
      btnCopy.disabled = true;
      footerInfo.textContent = '';
      rawData = [];
      tableData = [];
      selectedIndices.clear();
      lastClickedIndex = -1;
    }

    // â”€â”€ Sync selection from canvas â”€â”€â”€â”€â”€â”€â”€â”€
    function syncSelection(ids) {
      selectedIndices.clear();
      var rows = document.querySelectorAll('#tbody tr');
      var firstMatch = null;
      rows.forEach(function (row, i) {
        var rowId = row.getAttribute('data-id');
        if (ids.indexOf(rowId) !== -1) {
          row.classList.add('selected');
          selectedIndices.add(i);
          if (!firstMatch) firstMatch = row;
        } else {
          row.classList.remove('selected');
        }
      });
      if (firstMatch) {
        firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    window.onmessage = function (event) {
      var msg = event.data.pluginMessage;
      if (!msg) return;
      if (msg.type === 'result') renderTable(msg.data);
      if (msg.type === 'empty') showEmptyState('í”„ë ˆì„ì´ë‚˜ ì„¹ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
      if (msg.type === 'no-text') showEmptyState('ì„ íƒ ì˜ì—­ì— í…ìŠ¤íŠ¸ ë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');
      if (msg.type === 'sync-selection') syncSelection(msg.ids || []);
    };
  </script>
</body>

</html>