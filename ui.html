<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 12px;
      color: var(--figma-color-text, #333);
      background: var(--figma-color-bg, #fff);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--figma-color-border, #e5e5e5);
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }

    .badge {
      font-size: 11px;
      font-weight: 600;
      background: var(--figma-color-bg-secondary, #f0f0f0);
      color: var(--figma-color-text-secondary, #666);
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* â”€â”€ Table Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrap {
      flex: 1;
      overflow: auto;
      min-height: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    /* â”€â”€ Table Head â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    thead {
      position: sticky;
      top: 0;
      z-index: 2;
    }

    thead th {
      background: var(--figma-color-bg-secondary, #f5f5f5);
      font-size: 11px;
      font-weight: 600;
      text-align: left;
      padding: 8px 10px;
      color: var(--figma-color-text-secondary, #888);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-bottom: 1px solid var(--figma-color-border, #e0e0e0);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th:nth-child(1) {
      width: 26%;
    }

    th:nth-child(2) {
      width: 20%;
    }

    th:nth-child(3) {
      width: 10%;
    }

    th:nth-child(4) {
      width: 18%;
    }

    th:nth-child(5) {
      width: 13%;
    }

    th:nth-child(6) {
      width: 13%;
    }

    /* â”€â”€ Table Body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    tbody tr {
      border-bottom: 1px solid var(--figma-color-border, #f0f0f0);
      cursor: pointer;
      transition: background 0.12s ease;
    }

    tbody tr:hover {
      background: var(--figma-color-bg-hover, rgba(0, 100, 255, 0.06));
    }

    tbody tr:nth-child(even) {
      background: var(--figma-color-bg-secondary, rgba(0, 0, 0, 0.015));
    }

    tbody tr:nth-child(even):hover {
      background: var(--figma-color-bg-hover, rgba(0, 100, 255, 0.06));
    }

    /* Selected row */
    tbody tr.selected {
      background: rgba(0, 100, 255, 0.12) !important;
    }

    tbody td {
      padding: 7px 10px;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
    }

    td.text-content {
      font-weight: 500;
    }

    td.style-name {
      font-weight: 500;
    }

    td.font-info {
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 11px;
    }

    td.numeric {
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 11px;
      text-align: right;
    }

    /* â”€â”€ Unlinked row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    tr.unlinked td {
      color: #e00;
    }

    /* â”€â”€ Mixed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mixed {
      color: #d4a017;
      font-style: italic;
    }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-top: 1px solid var(--figma-color-border, #e5e5e5);
      flex-shrink: 0;
    }

    .footer-info {
      font-size: 11px;
      color: var(--figma-color-text-secondary, #999);
    }

    .footer-info .unlinked-count {
      color: #e00;
      font-weight: 600;
    }

    .footer-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: var(--figma-color-bg-brand, #0d99ff);
      color: #fff;
    }

    .btn-primary:hover {
      background: #0b85e0;
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .btn-secondary {
      background: var(--figma-color-bg-secondary, #f0f0f0);
      color: var(--figma-color-text, #333);
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    /* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 8px;
      color: var(--figma-color-text-secondary, #999);
    }

    .empty-state .icon {
      font-size: 32px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 13px;
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>ğŸ“ Text Finder</h1>
    <span class="badge" id="count">0 items</span>
  </div>

  <div class="table-wrap" id="tableWrap">
    <div class="empty-state" id="emptyState">
      <span class="icon">ğŸ”</span>
      <p>ë¶„ì„ ì¤‘...</p>
    </div>
    <table id="resultTable" style="display:none">
      <thead>
        <tr>
          <th>í…ìŠ¤íŠ¸ ë‚´ìš©</th>
          <th>ìŠ¤íƒ€ì¼ ì´ë¦„</th>
          <th>í¬ê¸°</th>
          <th>í°íŠ¸</th>
          <th>ìê°„</th>
          <th>í–‰ê°„</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer">
    <div class="footer-info" id="footerInfo"></div>
    <div class="footer-actions">
      <button class="btn btn-secondary" id="btnClose">ë‹«ê¸°</button>
      <button class="btn btn-primary" id="btnCopy" disabled>ğŸ“‹ CSV ë³µì‚¬</button>
    </div>
  </div>

  <script>
    var tableData = [];
    var selectedRowIndex = -1;

    function escapeCell(val) {
      if (val == null) return '';
      var str = String(val);
      if (/[\t\n\r"]/.test(str)) return '"' + str.replace(/"/g, '""') + '"';
      return str;
    }

    function esc(val) {
      return String(val).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function cellHtml(val, cls) {
      var s = String(val);
      var isMixed = s === 'Mixed' || s.indexOf('ğŸŸ¡') !== -1;
      var classes = cls || '';
      if (isMixed) classes += ' mixed';
      return '<td class="' + classes.trim() + '" title="' + esc(s) + '">' + esc(s) + '</td>';
    }

    // â”€â”€ Select row & notify plugin â”€â”€â”€â”€â”€â”€â”€â”€
    function selectRow(index) {
      // Remove previous selection
      var prev = document.querySelector('tr.selected');
      if (prev) prev.classList.remove('selected');

      selectedRowIndex = index;
      var row = document.querySelectorAll('#tbody tr')[index];
      if (row) row.classList.add('selected');

      // Send nodeId to plugin sandbox
      var nodeId = tableData[index] && tableData[index].nodeId;
      if (nodeId) {
        parent.postMessage({ pluginMessage: { type: 'select-node', nodeId: nodeId } }, '*');
      }
    }

    // â”€â”€ Render table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTable(rows) {
      tableData = rows;
      selectedRowIndex = -1;
      var tbody = document.getElementById('tbody');
      var table = document.getElementById('resultTable');
      var empty = document.getElementById('emptyState');
      var count = document.getElementById('count');
      var btnCopy = document.getElementById('btnCopy');
      var footerInfo = document.getElementById('footerInfo');

      if (!rows || rows.length === 0) {
        table.style.display = 'none';
        empty.querySelector('p').textContent = 'í…ìŠ¤íŠ¸ ë ˆì´ì–´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤';
        empty.style.display = 'flex';
        count.textContent = '0 items';
        btnCopy.disabled = true;
        footerInfo.textContent = '';
        return;
      }

      empty.style.display = 'none';
      table.style.display = 'table';
      count.textContent = rows.length + ' item' + (rows.length > 1 ? 's' : '');
      btnCopy.disabled = false;

      var unlinkedCount = rows.filter(function (r) { return r.isUnlinked; }).length;
      if (unlinkedCount > 0) {
        footerInfo.innerHTML = 'âš ï¸ ìŠ¤íƒ€ì¼ ë¯¸ì—°ê²°: <span class="unlinked-count">' + unlinkedCount + 'ê°œ</span>';
      } else {
        footerInfo.innerHTML = 'âœ… ëª¨ë“  í…ìŠ¤íŠ¸ì— ìŠ¤íƒ€ì¼ ì—°ê²°ë¨';
      }

      tbody.innerHTML = rows.map(function (r, i) {
        var rowClass = r.isUnlinked ? 'unlinked' : '';
        return '<tr class="' + rowClass + '" data-index="' + i + '">'
          + cellHtml(r.textContent, 'text-content')
          + cellHtml(r.styleName, 'style-name')
          + cellHtml(r.fontSize, 'numeric')
          + cellHtml(r.fontFamily, 'font-info')
          + cellHtml(r.letterSpacing, 'numeric')
          + cellHtml(r.lineHeight, 'numeric')
          + '</tr>';
      }).join('');

      // Attach click handlers via delegation
      tbody.onclick = function (e) {
        var tr = e.target.closest('tr');
        if (!tr) return;
        var idx = parseInt(tr.getAttribute('data-index'), 10);
        if (!isNaN(idx)) selectRow(idx);
      };
    }

    // â”€â”€ Copy as TSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btnCopy').addEventListener('click', function () {
      if (tableData.length === 0) return;
      var header = ['í…ìŠ¤íŠ¸ ë‚´ìš©', 'ìŠ¤íƒ€ì¼ ì´ë¦„', 'í¬ê¸°', 'í°íŠ¸', 'ìê°„', 'í–‰ê°„'];
      var lines = [header.join('\t')];
      tableData.forEach(function (r) {
        lines.push([
          escapeCell(r.textContent), escapeCell(r.styleName),
          escapeCell(r.fontSize), escapeCell(r.fontFamily),
          escapeCell(r.letterSpacing), escapeCell(r.lineHeight)
        ].join('\t'));
      });
      var tsv = lines.join('\n');
      var ta = document.createElement('textarea');
      ta.value = tsv; ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);

      var btn = document.getElementById('btnCopy');
      var orig = btn.textContent;
      btn.textContent = 'âœ… ë³µì‚¬ë¨!'; btn.style.background = '#22c55e';
      setTimeout(function () { btn.textContent = orig; btn.style.background = ''; }, 1500);
    });

    document.getElementById('btnClose').addEventListener('click', function () {
      parent.postMessage({ pluginMessage: { type: 'close' } }, '*');
    });

    // â”€â”€ Show empty state with message â”€â”€â”€â”€
    function showEmptyState(msg) {
      var table = document.getElementById('resultTable');
      var empty = document.getElementById('emptyState');
      var count = document.getElementById('count');
      var btnCopy = document.getElementById('btnCopy');
      var footerInfo = document.getElementById('footerInfo');
      table.style.display = 'none';
      empty.querySelector('.icon').textContent = 'ğŸ”';
      empty.querySelector('p').textContent = msg;
      empty.style.display = 'flex';
      count.textContent = '0 items';
      btnCopy.disabled = true;
      footerInfo.textContent = '';
      tableData = [];
      selectedRowIndex = -1;
    }

    window.onmessage = function (event) {
      var msg = event.data.pluginMessage;
      if (!msg) return;
      if (msg.type === 'result') renderTable(msg.data);
      if (msg.type === 'empty') showEmptyState('í”„ë ˆì„ì´ë‚˜ ì„¹ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
      if (msg.type === 'no-text') showEmptyState('ì„ íƒ ì˜ì—­ì— í…ìŠ¤íŠ¸ ë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');
    };
  </script>
</body>

</html>